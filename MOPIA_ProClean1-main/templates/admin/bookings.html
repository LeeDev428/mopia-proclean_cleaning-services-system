{% extends 'admin/admin_base.html' %}

{% block admin_title %}Manage Bookings{% endblock %}

{% block admin_content %}
<div class="dashboard-card">
    <div class="dashboard-card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">All Bookings</h5>
        <div>
            <button class="btn btn-outline-secondary btn-sm">Export</button>
        </div>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Customer</th>
                        <th>Service</th>
                        <th>Date & Time</th>
                        <th>Created At</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for booking in bookings %}
                    <tr>
                        <td>{{ booking.id }}</td>
                        <td>
                            <div>{{ booking.customer.name }}</div>
                            <small class="text-muted">{{ booking.customer.email }}</small>
                        </td>
                        <td>{{ booking.service.name }}</td>
                        <td>{{ booking.date|date:"M d, Y" }} at {{ booking.time|time:"g:i A" }}</td>
                        <td>{{ booking.created_at|date:"M d, Y" }} {{ booking.created_at|time:"g:i A" }}</td>
                        <td><span class="status-badge status-{{ booking.status }}">{{ booking.status|title }}</span></td>
                        <td>
                            {% if booking.status == 'pending' %}
                            <div class="d-flex gap-2">
                                <form method="post" action="{% url 'update_booking_status' %}" style="display:inline;">
                                    {% csrf_token %}
                                    <input type="hidden" name="booking_id" value="{{ booking.id }}">
                                    <input type="hidden" name="status" value="confirmed">
                                    <button type="submit" class="btn btn-sm btn-primary rounded-pill px-3">
                                        <i class="bi bi-check-circle-fill me-1"></i> Accept
                                    </button>
                                </form>
                                <!-- Modified Decline button to trigger the modal instead of submitting directly -->
                                <button type="button" class="btn btn-sm btn-outline-danger rounded-pill px-3 decline-booking-btn" 
                                        data-booking-id="{{ booking.id }}" data-booking-service="{{ booking.service.name }}" 
                                        data-customer-name="{{ booking.customer.name }}">
                                    <i class="bi bi-x-circle-fill me-1"></i> Decline
                                </button>
                            </div>
                            {% else %}
                            <button class="btn btn-sm btn-outline-primary rounded-pill booking-details" data-id="{{ booking.id }}">
                                <i class="bi bi-info-circle-fill me-1"></i> View Details
                            </button>
                            {% endif %}
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="6" class="text-center py-4">No bookings found.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <!-- Pagination for bookings -->
        <div class="d-flex justify-content-center py-3">
            <nav aria-label="Bookings pagination">
                <ul class="pagination">
                    {% if bookings.has_previous %}
                        <li class="page-item">
                            <a class="page-link" href="?page=1">&laquo; First</a>
                        </li>
                        <li class="page-item">
                            <a class="page-link" href="?page={{ bookings.previous_page_number }}">Previous</a>
                        </li>
                    {% else %}
                        <li class="page-item disabled">
                            <a class="page-link" href="#">&laquo; First</a>
                        </li>
                        <li class="page-item disabled">
                            <a class="page-link" href="#">Previous</a>
                        </li>
                    {% endif %}
                    
                    <li class="page-item active">
                        <span class="page-link">
                            Page {{ bookings.number }} of {{ bookings.paginator.num_pages }}
                        </span>
                    </li>
                    
                    {% if bookings.has_next %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ bookings.next_page_number }}">Next</a>
                        </li>
                        <li class="page-item">
                            <a class="page-link" href="?page={{ bookings.paginator.num_pages }}">Last &raquo;</a>
                        </li>
                    {% else %}
                        <li class="page-item disabled">
                            <a class="page-link" href="#">Next</a>
                        </li>
                        <li class="page-item disabled">
                            <a class="page-link" href="#">Last &raquo;</a>
                        </li>
                    {% endif %}
                </ul>
            </nav>
        </div>
    </div>
</div>
{% endblock %}

{% block admin_modals %}
<!-- Edit Booking Modal -->
<div class="modal fade" id="editBookingModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">Edit Booking</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="edit-booking-form" action="#" method="post">
                    {% csrf_token %}
                    <input type="hidden" id="edit-booking-id" name="booking_id">
                    
                    <div class="mb-3">
                        <label for="edit-status" class="form-label">Status</label>
                        <select class="form-select" id="edit-status" name="status" required>
                            <option value="pending">Pending</option>
                            <option value="confirmed">Confirmed</option>
                            <option value="completed">Completed</option>
                            <option value="cancelled">Cancelled</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="edit-date" class="form-label">Date</label>
                        <input type="date" class="form-control" id="edit-date" name="date" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="edit-time" class="form-label">Time</label>
                        <select class="form-select" id="edit-time" name="time" required>
                            <option value="08:00:00">8:00 AM</option>
                            <option value="10:00:00">10:00 AM</option>
                            <option value="12:00:00">12:00 PM</option>
                            <option value="14:00:00">2:00 PM</option>
                            <option value="16:00:00">4:00 PM</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="edit-admin-password" class="form-label">Confirm with Admin Password</label>
                        <input type="password" class="form-control" id="edit-admin-password" name="admin_password" required>
                    </div>
                    
                    <button type="submit" class="btn btn-primary">Update Booking</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Cancel Booking Confirmation Modal -->
<div class="modal fade" id="cancelBookingModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">Cancel Booking</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to cancel this booking? This action cannot be undone.</p>
                <form id="cancel-booking-form" action="#" method="post">
                    {% csrf_token %}
                    <input type="hidden" id="cancel-booking-id" name="booking_id">
                    
                    <div class="mb-3">
                        <label for="cancel-admin-password" class="form-label">Confirm with Admin Password</label>
                        <input type="password" class="form-control" id="cancel-admin-password" name="admin_password" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">No, Keep It</button>
                <button type="submit" class="btn btn-danger" id="confirm-cancel-booking">Yes, Cancel Booking</button>
            </div>
        </div>
    </div>
</div>

<!-- NEW: Decline Booking Reason Modal -->
<div class="modal fade" id="declineReasonModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">Decline Booking</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="decline-booking-form" action="{% url 'update_booking_status' %}" method="post">
                    {% csrf_token %}
                    <input type="hidden" id="decline-booking-id" name="booking_id">
                    <input type="hidden" name="status" value="cancelled">
                    
                    <div class="mb-3">
                        <h6 id="decline-booking-details" class="mb-3"></h6>
                        <label for="decline-reason" class="form-label">Reason for Declining</label>
                        <textarea class="form-control" id="decline-reason" name="decline_reason" rows="4" required 
                                  placeholder="Please provide a reason why this booking is being declined. This will be shown to the customer."></textarea>
                    </div>
                    
                    <div class="alert alert-warning">
                        <i class="bi bi-exclamation-triangle-fill me-2"></i>
                        The customer will be notified of this decline reason.
                    </div>
                    
                    <!-- Common reasons quick-select buttons -->
                    <div class="mb-3">
                        <label class="form-label">Quick Select Reasons:</label>
                        <div class="d-flex flex-wrap gap-2">
                            <button type="button" class="btn btn-sm btn-outline-secondary reason-preset" 
                                    data-reason="We regret to inform you that we're fully booked for this time slot.">Fully Booked</button>
                            <button type="button" class="btn btn-sm btn-outline-secondary reason-preset" 
                                    data-reason="The requested service is unavailable on the selected date.">Unavailable Service</button>
                            <button type="button" class="btn btn-sm btn-outline-secondary reason-preset" 
                                    data-reason="We cannot service your address location at this time.">Location Issue</button>
                            <button type="button" class="btn btn-sm btn-outline-secondary reason-preset" 
                                    data-reason="The requested service requires additional preparation. Please rebook with at least 2 days notice.">Insufficient Notice</button>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirm-decline-booking">
                    <i class="bi bi-x-circle-fill me-1"></i> Decline Booking
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block admin_extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Edit booking buttons
        document.querySelectorAll('.edit-booking').forEach(btn => {
            btn.addEventListener('click', function() {
                const id = this.getAttribute('data-id');
                document.getElementById('edit-booking-id').value = id;
                const editModal = new bootstrap.Modal(document.getElementById('editBookingModal'));
                editModal.show();
            });
        });
        
        // Delete booking buttons
        document.querySelectorAll('.delete-booking').forEach(btn => {
            btn.addEventListener('click', function() {
                const id = this.getAttribute('data-id');
                document.getElementById('cancel-booking-id').value = id;
                const cancelModal = new bootstrap.Modal(document.getElementById('cancelBookingModal'));
                cancelModal.show();
            });
        });
        
        // Confirm cancel booking
        document.getElementById('confirm-cancel-booking').addEventListener('click', function() {
            document.getElementById('cancel-booking-form').submit();
        });
        
        // NEW: Handle decline booking button clicks
        document.querySelectorAll('.decline-booking-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const bookingId = this.getAttribute('data-booking-id');
                const serviceName = this.getAttribute('data-booking-service');
                const customerName = this.getAttribute('data-customer-name');
                
                // Set values in the decline reason modal
                document.getElementById('decline-booking-id').value = bookingId;
                document.getElementById('decline-booking-details').textContent = 
                    `Declining ${serviceName} booking for ${customerName}`;
                
                // Show the decline reason modal
                const declineModal = new bootstrap.Modal(document.getElementById('declineReasonModal'));
                declineModal.show();
            });
        });
        
        // Handle quick-select reason buttons
        document.querySelectorAll('.reason-preset').forEach(btn => {
            btn.addEventListener('click', function() {
                const reasonText = this.getAttribute('data-reason');
                document.getElementById('decline-reason').value = reasonText;
            });
        });
        
        // Submit the decline form when confirmed
        document.getElementById('confirm-decline-booking').addEventListener('click', function() {
            // Validate that a reason was provided
            const reasonField = document.getElementById('decline-reason');
            if (!reasonField.value.trim()) {
                reasonField.classList.add('is-invalid');
                // Add an error message
                if (!document.getElementById('reason-error')) {
                    const errorDiv = document.createElement('div');
                    errorDiv.id = 'reason-error';
                    errorDiv.className = 'invalid-feedback';
                    errorDiv.textContent = 'Please provide a reason for declining the booking';
                    reasonField.parentNode.appendChild(errorDiv);
                }
                return;
            }
            
            // Submit the form
            document.getElementById('decline-booking-form').submit();
        });
    });
</script>
{% endblock %}